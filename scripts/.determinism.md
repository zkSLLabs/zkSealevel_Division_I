# Determinism Guide

This project enforces strict determinism at every layer. Follow these rules to avoid hidden sources of nondeterminism.

- Time/Clock: Use UTC only. In tests, freeze time via SOURCE_DATE_EPOCH or fixed inputs. Respect MAX_CLOCK_SKEW.
- Encoding: UTF-8 only; no BOMs; LF newlines. Hex strings normalized to lowercase.
- Sorting: Never rely on object key iteration order; canonicalize with lexicographically sorted keys.
- Randomness: No PRNG in critical paths. For tests, record seeds and artifacts.
- Concurrency: Use Idempotency-Key for POSTs; serialize by artifact_id for file writes.
- Numeric types: Serialize large u64 values as strings when crossing JS boundaries to prevent precision loss.
- Colors/TTY: Disable color in CI (NO_COLOR=1, unset FORCE_COLOR) to keep logs stable.
- PDAs/Bytes: Derive PDAs exactly as specified; verify sizes (Config=168, ValidatorRecord=136, ProofRecord=262).
- DS: 110-byte DS exact layout; ds_hash = blake3(DS). Recompute, do not trust input.
- Borsh: Field order must match program specification; discriminator = sha256("global:anchor_proof")[0..8].

Run scripts/dev_bootstrap.sh to validate toolchains and apply migrations with deterministic settings.
